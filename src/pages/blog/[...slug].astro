---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.id },
		props: post,
	}));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await render(post);

// --- Logika untuk mencari Related & Next/Previous Posts ---
const allPosts = await getCollection('blog');

// Urutkan postingan berdasarkan tanggal untuk navigasi Next/Previous
const sortedPosts = allPosts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const currentIndex = sortedPosts.findIndex(
	(p) => p.id === post.id
);

const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

// Filter untuk postingan terkait (berdasarkan tanggal publikasi)
const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
const relatedPosts = sortedPosts
  .filter((p) => p.id !== post.id) // Pastikan postingan saat ini tidak masuk
  .filter((p) => {
    const diff = Math.abs(p.data.pubDate.valueOf() - post.data.pubDate.valueOf());
    return diff <= thirtyDaysInMs;
  })
  .slice(0, 7); //  3 postingan terkait

---

<BlogPost {...post.data}>
	<Content />

	{relatedPosts.length > 0 && (
		<div class="related-posts">
			<h2>Postingan Terkait</h2>
			<ul>
				{relatedPosts.map(relatedPost => (
					<li>
						<a href={`/blog/${relatedPost.id}`}>
							{relatedPost.data.title}
						</a>
					</li>
				))}
			</ul>
		</div>
	)}

	<div class="next-prev-nav">
		{prevPost && (
			<a href={`/blog/${prevPost.id}`} class="prev-link">
				&larr; Sebelumnya: {prevPost.data.title}
			</a>
		)}
		{nextPost && (
			<a href={`/blog/${nextPost.id}`} class="next-link">
				Selanjutnya: {nextPost.data.title} &rarr;
			</a>
		)}
	</div>
</BlogPost>

<style>
  .related-posts {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e5e5;
  }
  .related-posts h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }
  .related-posts ul {
    list-style: none;
    padding: 0;
  }
  .related-posts li {
    margin-bottom: 0.5rem;
  }

  .next-prev-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e5e5;
  }
  .next-prev-nav a {
    text-decoration: none;
    color: #007bff;
    transition: color 0.2s ease-in-out;
  }
  .next-prev-nav a:hover {
    color: #0056b3;
  }
</style>
